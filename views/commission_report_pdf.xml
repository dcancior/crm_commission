<?xml version="1.0" encoding="utf-8"?>
<!--
╔════════════════════════════════════════════════════════════════════╗
║  DCR INFORMATIC SERVICES SAS DE CV                                 ║
║  Web: https://www.dcrsoluciones.com                                ║
║  Contacto: info@dcrsoluciones.com                                  ║
║                                                                    ║
║  Este módulo está bajo licencia (LGPLv3).                          ║
║  Licencia completa: https://www.gnu.org/licenses/lgpl-3.0.html     ║
╚════════════════════════════════════════════════════════════════════╝
-->
<odoo>
  <template id="commission_report_pdf">
    <t t-call="web.html_container">
      <t t-call="web.external_layout">
        <div class="page">

          <style type="text/css">
            /* Ajustes de la tabla para PDF */
            table.commission-table {
              width: 100%;
              border-collapse: collapse;
              table-layout: fixed; /* respeta colgroup en PDF */
            }
            table.commission-table th,
            table.commission-table td {
              padding: 4px 6px;
              vertical-align: top;
            }
            /* ↓ Solo el contenido (no el encabezado) con tipografía un punto menor */
            table.commission-table tbody td,
            table.commission-table tfoot td,
            table.commission-table tfoot th {
              font-size: 11pt;
              line-height: 1.2;
            }
            /* Evitar quiebres en importes y mantenerlos compactos */
            .col-amount { white-space: nowrap; }
            /* Permitir wrap normal en Partner (cliente) para no comer ancho */
            .col-partner { white-space: normal; word-break: break-word; }
            /* Centrar el Sí/No de comisión pagada para mejor legibilidad */
            .col-paid { text-align: center; }
          </style>

          <h2>Reporte de Comisión</h2>

          <div class="row mt16 mb8">
            <div class="col-6">
              <p><strong>Vendedor:</strong> <t t-esc="user_name"/></p>
              <p>
                <strong>Periodo:</strong>
                <t t-esc="date_start_str"/> — <t t-esc="date_end_str"/>
              </p>
              <p>
                <strong>Filtro:</strong>
                <t t-esc="{'all':'Todas','paid':'Pagadas','unpaid':'No pagadas'}.get(filter_payment or 'all', 'Todas')"/>
              </p>
            </div>
            <div class="col-6">
              <p><strong>Porcentaje Comisión (equipo):</strong> <t t-esc="commission_percent_str"/>%</p>
              <p><strong>Total Ventas (Base):</strong> <t t-esc="amount_total_str"/></p>
              <p><strong>Total Comisión:</strong> <t t-esc="commission_total_str"/></p>
            </div>
          </div>

          <h3 class="mt16">Detalle de Facturas</h3>

          <table class="table table-sm o_main_table commission-table">
            <!-- Control fino de anchos de columna -->
            <colgroup>
              <!-- Ajusta si cambias el orden de columnas -->
              <col style="width: 8%;" />   <!-- Comisión pagada -->
              <col style="width: 14%;" />  <!-- # Factura -->
              <col style="width: 22%;" />  <!-- Cliente (más angosta) -->
              <col style="width: 10%;" />  <!-- Método -->
              <col style="width: 14%;" />  <!-- Fecha/Hora pago -->
              <col style="width: 16%;" />  <!-- Total sin IVA (más ancho) -->
              <col style="width: 16%;" />  <!-- Comisión (más ancho) -->
            </colgroup>

            <thead>
              <tr>
                <th>Comisión pagada</th>
                <th># Factura</th>
                <!-- <th>Fecha</th> -->
                <th>Cliente</th>
                <!-- <th class="text-right">% Com.</th> -->
                <th>Método</th>
                <th>Fecha/Hora pago</th>
                <!-- <th>Registró</th> -->
                <th class="text-right">Total sin IVA</th>
                <th class="text-right">Comisión</th>
              </tr>
            </thead>

            <tbody>
              <t t-if="invoice_lines and len(invoice_lines)">
                <t t-foreach="invoice_lines" t-as="l">
                  <tr>
                    <td class="col-paid"><t t-esc="l.get('commission_paid')"/></td>
                    <td><t t-esc="l.get('number')"/></td>
                    <!-- <td><t t-esc="l.get('date')"/></td> -->
                    <td class="col-partner"><t t-esc="l.get('partner')"/></td>
                    <!-- <td class="text-right"><t t-esc="l.get('commission_percent_str') or l.get('commission_percent')"/></td> -->
                    <td><t t-esc="l.get('pay_method')"/></td>
                    <!-- <td><t t-esc="l.get('pay_datetime')"/></td> -->
                    <td><t t-esc="(l.get('pay_datetime') or '').split(' ')[0]"/></td> <!-- Solo muestra la fecha, no la hora -->
                    <!-- <td><t t-esc="l.get('pay_user')"/></td> -->
                    <td class="text-right col-amount">
                      <t t-esc="l.get('amount_untaxed_str') or l.get('amount_untaxed')"/>
                    </td>
                    <td class="text-right col-amount">
                      <t t-esc="l.get('commission_amount_str') or l.get('commission_amount')"/>
                    </td>
                  </tr>
                </t>
              </t>
              <t t-else="">
                <tr>
                  <!-- 7 columnas visibles -->
                  <td colspan="7" class="text-center text-muted">
                    No hay facturas en el periodo/filtro seleccionado.
                  </td>
                </tr>
              </t>
            </tbody>

            <tfoot>
              <tr>
                <!-- Hay 7 columnas. Antes de los totales monetarios hay 5 -->
                <th colspan="5" class="text-right">Totales</th>
                <th class="text-right col-amount">
                  <t t-esc="amount_total_str or amount_total"/>
                </th>
                <th class="text-right col-amount">
                  <t t-esc="commission_total_str or commission_total"/>
                </th>
              </tr>
            </tfoot>
          </table>
        </div>
      </t>
    </t>
  </template>

  <report
    id="action_commission_report_pdf"
    model="commission.report.wizard"
    string="Reporte de Comisión"
    report_type="qweb-pdf"
    name="crm_commission.commission_report_pdf"
    file="crm_commission.commission_report_pdf"
    print_report_name="'Reporte_Comision_%s_a_%s' % (date_start_str.replace('/','-'), date_end_str.replace('/','-'))"
  />
</odoo>
