<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- ===== Subform dedicado para las líneas ===== -->
  <record id="view_commission_report_line_form" model="ir.ui.view">
    <field name="name">commission.report.wizard.line.form</field>
    <field name="model">commission.report.wizard.line</field>
    <field name="arch" type="xml">
      <form string="Pago de comisión (línea)">
        <group>
          <!-- Claves invisibles -->
          <field name="wizard_id"        invisible="1" readonly="1" force_save="1"
                 options="{'no_open': True, 'no_create': True, 'no_create_edit': True}"/>
          <field name="payment_entry_id" invisible="1" readonly="1" force_save="1"
                 options="{'no_open': True, 'no_create': True, 'no_create_edit': True}"/>
          <field name="move_id"          invisible="1" readonly="1" force_save="1"
                 options="{'no_open': True, 'no_create': True, 'no_create_edit': True}"/>

          <!-- Solo lectura de la factura -->
          <field name="invoice_date" readonly="1"/>
          <field name="partner_id"   readonly="1" options="{'no_open': True, 'no_create_edit': True}"/>
          <field name="amount_untaxed" readonly="1"/>
          <field name="commission_percent" readonly="1"/>

          <!-- Único editable -->
          <field name="payment_method"/>

          <!-- Sellos -->
          <field name="payment_datetime" readonly="1"/>
          <field name="payment_user_id" readonly="1"/>
          <field name="commission_paid" readonly="1" widget="boolean_toggle"/>
          <field name="commission_amount" readonly="1"/>
        </group>
      </form>
    </field>
  </record>

  <!-- ===== Vista principal del wizard ===== -->
  <record id="view_commission_report_wizard_form" model="ir.ui.view">
    <field name="name">commission.report.wizard.form</field>
    <field name="model">commission.report.wizard</field>
    <field name="arch" type="xml">
      <form string="Reporte de Comisión (rango)">
        <sheet>

          <!-- Moneda para formateo de campos monetary -->
          <field name="currency_id" invisible="1"/>

          <!-- Filtros -->
          <group string="Filtros">
            <field name="user_id" required="1" options="{'no_create_edit': True}"/>
            <field name="date_start" required="1"/>
            <field name="date_end" required="1"/>
            <field name="filter_payment"/>
          </group>

          <!-- Totales / KPIs -->
          <group string="Totales">
            <field name="commission_percent" readonly="1"/>
            <field name="lines_count" readonly="1"/>
            <field name="amount_total" readonly="1"
                   widget="monetary"
                   options="{'currency_field': 'currency_id'}"/>
            <field name="commission_total" readonly="1"
                   widget="monetary"
                   options="{'currency_field': 'currency_id'}"/>
          </group>

          <notebook>
            <page string="Facturas (según filtro)">
              <!-- ÚNICA tabla: las líneas ya vienen filtradas desde Python con _load_lines() -->
              <field name="line_ids" nolabel="1"
                     mode="tree"
                     context="{
                       'no_open': 0,
                       'default_wizard_id': active_id,
                       'form_view_ref': 'crm_commission.view_commission_report_line_form'
                     }"
                     options="{'no_open': False, 'no_create': True}">
                <tree create="0" edit="0" delete="0">
                  <field name="move_id" readonly="1" options="{'no_open': True, 'no_create_edit': True}"/>
                  <field name="invoice_date" readonly="1"/>
                  <field name="partner_id" readonly="1" options="{'no_open': True, 'no_create_edit': True}"/>
                  <field name="amount_untaxed" readonly="1" sum="Total Base"/>
                  <field name="commission_percent" readonly="1"/>
                  <!-- Se puede ver aquí pero se edita en el subform -->
                  <field name="payment_method"/>
                  <field name="payment_datetime" readonly="1"/>
                  <field name="payment_user_id" readonly="1"/>
                  <field name="commission_paid" readonly="1" widget="boolean_toggle"/>
                  <field name="commission_amount" readonly="1" sum="Total Comisión"/>
                </tree>

                <!-- Subform inline (opcional) -->
                <form string="Pago de comisión" create="0" delete="0">
                  <group>
                    <field name="wizard_id"        invisible="1" readonly="1" force_save="1"/>
                    <field name="payment_entry_id" invisible="1" readonly="1" force_save="1"/>
                    <field name="move_id"          invisible="1" readonly="1" force_save="1"
                           options="{'no_open': True, 'no_create_edit': True}"/>
                    <field name="invoice_date" readonly="1"/>
                    <field name="partner_id" readonly="1"/>
                    <field name="amount_untaxed" readonly="1"/>
                    <field name="commission_percent" readonly="1"/>
                    <field name="payment_method"/>
                    <field name="payment_datetime" readonly="1"/>
                    <field name="payment_user_id" readonly="1"/>
                    <field name="commission_paid" readonly="1" widget="boolean_toggle"/>
                    <field name="commission_amount" readonly="1"/>
                  </group>
                </form>
              </field>
            </page>
          </notebook>
        </sheet>

        <footer>
          <button name="action_save" type="object" string="Guardar" class="btn-primary"/>
          <button name="action_refresh" type="object" string="Actualizar" class="btn-secondary"/>
          <button name="action_mark_all_paid" type="object" string="Marcar todas como pagadas" class="oe_highlight"/>
          <button name="action_print_pdf" type="object" string="Descargar PDF" class="btn-primary"/>
          <button string="Cerrar" class="btn-secondary" special="cancel"/>
        </footer>
      </form>
    </field>
  </record>

  <!-- ===== Wizard: Marcar comisiones pagadas (masivo) ===== -->
  <record id="view_commission_mass_pay_wizard_form" model="ir.ui.view">
    <field name="name">commission.mass.pay.wizard.form</field>
    <field name="model">commission.mass.pay.wizard</field>
    <field name="arch" type="xml">
      <form string="Marcar comisiones como pagadas">
        <group>
          <field name="payment_method" required="1"/>
          <!-- AQUÍ el nombre correcto según tu Python -->
          <field name="payment_datetime"/>
          <field name="note"/>
        </group>
        <group>
          <field name="entry_ids"
                 widget="many2many_tags"
                 options="{'no_open': True, 'no_create': True}"/>
        </group>
        <footer>
          <button name="action_confirm" type="object" string="Aplicar" class="oe_highlight"/>
          <button string="Cancelar" special="cancel"/>
        </footer>
      </form>
    </field>
  </record>

  <!-- Acción para abrir el wizard principal -->
  <act_window id="action_commission_report_wizard"
              name="Reporte de Comisión de Ventas"
              res_model="commission.report.wizard"
              view_mode="form"
              target="new"/>

  <!-- Menú -->
  <menuitem id="menu_commission_report_root"
            name="Comisiones de Ventas"
            sequence="100"
            groups="crm_commission.group_commission_view"
            web_icon="crm_commission,static/description/icon_commission.svg"/>

  <menuitem id="menu_commission_report_wizard"
            name="Reporte de Comisión de Ventas"
            parent="menu_commission_report_root"
            action="action_commission_report_wizard"
            sequence="10"
            groups="crm_commission.group_commission_view"/>

</odoo>
