<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <record id="view_order_form_mechanic_line" model="ir.ui.view"> <!-- Vista heredada para sale.order -->
    <field name="name">sale.order.form.mechanic.line</field> <!-- Nombre interno de la vista -->
    <field name="model">sale.order</field> <!-- Modelo principal -->
    <field name="inherit_id" ref="sale.view_order_form"/> <!-- Hereda el formulario de pedidos de venta -->
    <field name="arch" type="xml"> <!-- Inicio de modificaciones XML -->

      <xpath expr="//field[@name='order_line']/tree" position="inside"> <!-- Inyecta campos auxiliares en el tree -->
        <field name="display_mechanic_fields" invisible="1"/> <!-- Flag existente para visibilidad -->
        <field name="product_type" invisible="1"/> <!-- Related a product_id.type (store=True en el modelo) -->
      </xpath>

      <xpath expr="//field[@name='order_line']/tree" position="attributes"> <!-- Decora filas según condición -->
        <attribute name="decoration-warning">product_type == 'service' and not mechanic_id</attribute> <!-- Naranja si es servicio y falta mecánico -->
      </xpath>

      <xpath expr="//field[@name='order_line']/tree/field[@name='price_subtotal']" position="before"> <!-- Inserta columna antes del subtotal -->
        <field name="mechanic_id"
               string="Columna de mecánicos" 
               optional="show" 
               domain="[('active','=',True), ('job_id.name', '=', 'Mecánico')]" 
               /> <!-- Si quisieras bloquear, agrega attrs required con product_type='service' -->
      </xpath>

      <xpath expr="//field[@name='order_line']/tree/field[@name='price_subtotal']" position="after"> <!-- Campo costo mecánico después del subtotal -->
        <field name="mechanic_cost_subtotal"
               optional="hide" 
               attrs="{'invisible':[('display_mechanic_fields','=',False)]}"/> <!-- Visible sólo cuando aplica el flag -->
      </xpath>

      <xpath expr="//field[@name='order_line']/form" position="inside"> <!-- Inyecta flags en el formulario -->
        <group invisible="1"> <!-- Grupo oculto para flags -->
          <field name="display_mechanic_fields"/> <!-- Flag existente -->
          <field name="product_type"/> <!-- Related product_id.type -->
        </group>
      </xpath>

      <xpath expr="//field[@name='order_line']/form//group[1]" position="after"> <!-- Grupo de campos del mecánico en el form -->
        <group string="Mecánico"> <!-- Sección visible de mecánico -->
          <field name="mechanic_id"
                 domain="[('active','=',True), ('job_id.name', '=', 'Mecánico')]" /> <!-- Selector de mecánico -->
          <field name="mechanic_hours_required" readonly="1"
                 attrs="{'invisible':[('display_mechanic_fields','=',False)]}"/> <!-- Horas requeridas (sólo si flag) -->
          <field name="mechanic_cost_per_hour" readonly="1"
                 attrs="{'invisible':[('display_mechanic_fields','=',False)]}"/> <!-- Costo por hora (sólo si flag) -->
          <field name="mechanic_cost_subtotal" readonly="1"
                 attrs="{'invisible':[('display_mechanic_fields','=',False)]}"/> <!-- Subtotal mecánico (sólo si flag) -->
        </group>
      </xpath>

    </field> <!-- Fin de modificaciones XML -->
  </record>
</odoo>
